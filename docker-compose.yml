services:
  validation-of-acceptance-certificates-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_of_acceptance_certificates_app
    restart: always
    depends_on:
      - redis
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
    ports:
      - "8309:8009"

  redis:
    image: redis:7-alpine
    container_name: validation_redis
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_celery_worker
    restart: always
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    volumes:
      - .:/app
    command:
      sh -c "
        sleep 5 &&
        celery -A src.celery.celery:celery_app worker 
          --loglevel=info 
          --concurrency=4 
          --hostname=worker@%h
      "

  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_celery_beat
    restart: always
    depends_on:
      - redis
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
      - CELERY_BROKER_URL=redis://redis:6379/1
    volumes:
      - .:/app
      - celery_beat_data:/tmp
    command:
      sh -c "
        sleep 10 &&
        celery -A src.celery.celery:celery_app beat 
          --loglevel=info 
          --scheduler=celery.beat.PersistentScheduler 
          --schedule=/tmp/celerybeat-schedule
      "

  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_flower
    restart: always
    depends_on:
      - redis
      - celery_worker
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/1
    ports:
      - "8310:5555"
    volumes:
      - .:/app
    command:
      sh -c "
        sleep 15 &&
        celery -A src.celery.celery:celery_app flower 
          --port=5555 
          --broker=${CELERY_BROKER_URL}
      "

volumes:
  redis_data:
  celery_beat_data: