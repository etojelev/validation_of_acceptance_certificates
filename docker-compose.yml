services:

  validation-of-acceptance-certificates-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_of_acceptance_certificates_app
    restart: always
    depends_on:
      - redis
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
    ports:
      - "8309:8009"

  redis:
    image: redis:7-alpine
    container_name: validation_redis
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_celery_worker
    restart: always
    depends_on:
      - redis
      - validation-of-acceptance-certificates-app
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - CELERY_TIMEZONE=${CELERY_TIMEZONE:-UTC}
      - CELERY_RESULT_EXPIRES=${CELERY_RESULT_EXPIRES:-3600}
      - CELERY_WORKER_PREFETCH_MULTIPLIER=${CELERY_WORKER_PREFETCH_MULTIPLIER:-1}
      - CELERY_WORKER_MAX_TASKS_PER_CHILD=${CELERY_WORKER_MAX_TASKS_PER_CHILD:-1000}
      - CELERY_TASK_SOFT_TIME_LIMIT=${CELERY_TASK_SOFT_TIME_LIMIT:-60}
      - CELERY_TASK_TIME_LIMIT=${CELERY_TASK_TIME_LIMIT:-120}
    volumes:
      - .:/app
    command: uv run celery -A src.celery worker --loglevel=info --concurrency=4

  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_celery_beat
    restart: always
    depends_on:
      redis:
        condition: service_started
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis

  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: validation_flower
    restart: always
    depends_on:
      - redis
      - celery_worker
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_TIMEZONE=${CELERY_TIMEZONE:-UTC}
    ports:
      - "8310:5555"
    volumes:
      - .:/app
    command: uv run celery -A src.celery flower --port=5555 --broker=${CELERY_BROKER_URL}

volumes:
  redis_data:
  celery_beat_data: